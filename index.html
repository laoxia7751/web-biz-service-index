<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <link rel="stylesheet" href="./assets/index.css" />
    <link href="./assets/tailwind.min.css" rel="stylesheet" />
    <link href="./assets/style.css" rel="stylesheet" />
    <script src="./assets/vue.global.js"></script>
    <script src="./assets/index.full.js"></script>
    <title>web-biz-serviceËØ∑Ê±ÇÂ∫ìÊñπÊ≥ïÊ±áÊÄª</title>
  </head>
  <body >
    <div id="app">
      <el-container style="height: 100vh">
        <el-aside width="300px" style="background-color: rgb(238, 241, 246)">
          <el-menu class="el-menu-vertical-demo" :default-active="activeBizName">
            <el-menu-item :index="''" @click="menuClick('')">
              <span>ÂÖ®ÈÉ®</span>
            </el-menu-item>
            <el-menu-item :index="bizName" v-for="(data, bizName, index) in descMap" :key="bizName" @click="menuClick(bizName)">
              <span>{{bizName}}-{{data?.desc || ''}}</span>
            </el-menu-item>
          </el-menu>
        </el-aside>
        <el-container>
          <el-header class="flex justify-center items-center relative">
            <div class="w-1/3 flex justify-center items-center">
              <div class="absolute top-1/2 left-10 transform -translate-y-2/4">
                <el-tag class="version" type="danger">ÁâàÊú¨:1.8.24</el-tag>
              </div>
              <el-input
                v-model="searchValue"
                placeholder="ËØ∑ËæìÂÖ•"
                class="input-with-select"
                clearable @change="search" @clear="search"
              >
                <template #prepend>
                  <el-select v-model="searchType" placeholder="Select" style="width: 115px">
                    <el-option label="ËØ∑Ê±ÇÂêçÁß∞" value="1"></el-option>
                    <el-option label="ËØ∑Ê±ÇURL" value="2"></el-option>
                    <el-option label="ËØ∑Ê±ÇÊèèËø∞" value="3"></el-option>
                  </el-select>
                </template>
                <template #append>
                  <el-button @click="search">ÊêúÁ¥¢</el-button>
                </template>
              </el-input>
            </div>
            <div class="absolute top-1/2 right-10 transform -translate-y-2/4">
              <el-link  type="info" href="https://greasyfork.org/zh-CN/scripts/450328-swaggerskiptocustommethods" target="_blank">Ê≤πÁå¥ËÑöÊú¨Â∑•ÂÖ∑</el-link>
              &nbsp;
              <el-switch
                v-model="dark"
                inline-prompt
                active-text="‚òÄÔ∏è"
                inactive-text="üåô"
                @change="setDefaultShowType"
              />
            </div>
          </el-header>
          <el-main>
            <el-table :data="tableData" row-key="methodName" :expand-row-keys="expands" @row-click="clickRowHandle" v-loading="loading">
              <el-table-column type="expand">
                <template v-slot="props">
                  <el-row class="px-10 py-5">
                    <el-col :span="24" class="mb-3">
                      <h3 class="font-bold text-md mb-1">ËØ∑Ê±ÇÁ§∫‰æã</h3>
                      <code> {{getExample(props.row)}} </code>
                    </el-col>
                    <el-col :span="12">
                      <el-descriptions title="ËØ∑Ê±ÇÂèÇÊï∞" :column="1">
                        <el-descriptions-item :label="key" v-for="(value, key) in getParams(props.row)">{{value || ''}}</el-descriptions-item>
                      </el-descriptions>
                    </el-col>
                    <el-col :span="12">
                      <el-descriptions title="ËØ∑Ê±ÇÁªìÊûú" :column="1">
                        <el-descriptions-item :label="key" v-for="(value, key) in getResponse(props.row)">{{value || ''}}</el-descriptions-item>
                      </el-descriptions>
                    </el-col>
                  </el-row>
                </template>
              </el-table-column>
              <el-table-column label="ËØ∑Ê±ÇÂêçÁß∞" prop="methodName"> </el-table-column>
              <el-table-column label="ÊâÄÂ±ûÊ®°Âùó" prop="bizName" width="280px">
                <template #default="scope">
                  <el-tag>{{scope.row.subBiz || scope.row.bizName}}</el-tag> -
                  <span class="text-sm muduleLabel">{{descMap[scope.row.subBiz || scope.row.bizName]?.desc || ''}}</span>
                </template>
              </el-table-column>
              <el-table-column label="ËØ∑Ê±ÇÊèèËø∞" prop="summary"> </el-table-column>
              <el-table-column label="ËØ∑Ê±ÇURL" prop="url"> </el-table-column>
              <el-table-column label="ËØ∑Ê±ÇÁ±ªÂûã" prop="methods" width="150px">
                <template #default="scope">
                  <el-tag size="small" :type="methodColorType[scope.row.methods]" effect="dark">{{scope.row.methods.toUpperCase()}}</el-tag>
                </template>
              </el-table-column>

              <el-table-column label="ËØ∑Ê±ÇÁâàÊú¨" align="center" width="120px">
                <template #default="scope">
                  <el-tag>{{scope.row.version}}</el-tag>
                </template>
              </el-table-column>
              <el-table-column label="Êìç‰Ωú" align="center" width="150px">
                <template #default="scope">
                  <el-button size="small" type="primary" @click.stop="skipSwagger(scope.row)" v-if="descMap[scope.row.bizName]?.doc">Êü•Áúã</el-button>
                  <el-button size="small" type="warning"  @click.stop="copyName(scope.row)" v-if="descMap[scope.row.bizName]?.doc">Â§çÂà∂</el-button>
                </template>
              </el-table-column>
            </el-table>
          </el-main>
        </el-container>
      </el-container>
    </div>

    <script>
      const App = {
        mounted() {
          fetch('biz.json', { cache: 'no-cache', headers: { 'cache-control': 'no-cache' } })
            .then((res) => res.json())
            .then((res) => {
              this.bizData = res;
              this.search();
              this.loading = false;
            });
            document.querySelector('html').setAttribute('data-theme', this.dark ? 'dark' : 'light');
        },
        data() {
          return {
            // ÂΩìÂâçÈÄâ‰∏≠bizÊ®°Âùó
            activeBizName: 'gcsBiz',
            // jsonÊï∞ÊçÆ
            bizData: {},
            // ÊêúÁ¥¢Á±ªÂûã
            searchType: '1',
            // ÊêúÁ¥¢ÂÄº
            searchValue: '',
            // ÊúÄÁªàÂ±ïÁ§∫ÁªìÊûú
            tableData: [],
            // Ë¶ÅÂ±ïÂºÄÁöÑË°åÔºåÊï∞ÂÄºÁöÑÂÖÉÁ¥†ÊòØrowÁöÑkeyÂÄº
            expands: [],
            // Âä†ËΩΩ
            loading: true,
            // ÊöóÈªëÊ®°Âºè
            dark: localStorage.getItem('dark') === 'true',
          };
        },
        computed: {
          // bizÊ®°Âùó‰ø°ÊÅØËØ¥Êòé
          descMap() {
            return {
              aggsBiz: { noSwagger:true, desc: 'ËÅöÂêàÊü•ËØ¢ÊúçÂä°', doc: 'http://10.8.109.235:3885' },
              alarmBiz: { noSwagger:false, desc: 'ÂëäË≠¶ÊúçÂä°', doc: 'http://10.8.109.235:20173' },
              alertsPlatformBiz: { noSwagger:false, desc: 'ÂëäË≠¶Âπ≥Âè∞ÊúçÂä°', doc: 'http://10.8.109.235:20080' },
              assetBiz: { noSwagger:true, desc: 'ËµÑ‰∫ßÊúçÂä°', doc: 'http://10.8.109.235:13735' },
              associatedBiz: { noSwagger:true, desc: '‰∫ã‰ª∂ÊúçÂä°-‰∫ã‰ª∂ÂÖ≥ËÅî', doc: 'http://10.8.109.235:3088' },
              auditBiz: { noSwagger:false, desc: 'ÂÆ°ËÆ°ÊúçÂä°', doc: 'http://10.8.109.233:32537' },
              authBiz: { noSwagger:false, desc: 'ËÆ§ËØÅÊéàÊùÉÊúçÂä°', doc: 'http://10.8.109.235:9810' },
              cgsBiz: { noSwagger:false, desc: 'ËÆ§Áü•ÊúçÂä°(ÊñáÂ≠óËΩ¨ËØ≠Èü≥)', doc: 'http://10.8.109.235:3378' },
              dcsBiz: { noSwagger:false, desc: 'Êï∞ÊçÆ‰∏≠Âè∞ÊúçÂä°', doc: 'http://10.8.109.235:3079' },
              edmsBiz: { noSwagger:false, desc: 'Ë∞ÉÂ∫¶ÊúçÂä°', doc: 'http://10.8.109.235:3333' },
              eventBiz: { noSwagger:true, desc: '‰∫ã‰ª∂ÊúçÂä°', doc: 'http://10.8.109.235:3088' },
              fileStorageBiz: { noSwagger:false, desc: 'Êñá‰ª∂Â≠òÂÇ®ÊúçÂä°', doc: 'http://10.8.109.235:17591' },
              gcsBiz: { noSwagger:false, desc: 'GPSÁÇπ‰ΩçÊúçÂä°', doc: 'http://10.8.109.235:7319' },
              geoAnalysisBiz: { noSwagger:false, desc: 'Âú∞ÁêÜÂàÜÊûêÊúçÂä°', doc: 'http://10.8.109.235:3099' },
              geoDataBiz: { noSwagger:false, desc: 'Âú∞ÁêÜÊï∞ÊçÆÊúçÂä°', doc: 'http://10.8.109.233:3098' },
              mmtBiz: { noSwagger:false, desc: 'Êãç‰º†ÊúçÂä°', doc: 'http://10.8.109.235:17599' },
              modelAnalysisBiz: { noSwagger:false, desc: 'Ê®°ÂûãÂàÜÊûêÊúçÂä°', doc: 'http://10.8.109.235:20175' },
              msgBiz: { noSwagger:false, desc: 'Áü≠‰ø°ÊúçÂä°', doc: 'http://10.8.109.235:3398' },
              ntsBiz: { noSwagger:false, desc: 'ÈÄöÁü•ÊúçÂä°', doc: 'http://10.8.109.235:50078' },
              orgsBiz: { noSwagger:false, desc: 'ÁªÑÁªáÊû∂ÊûÑÊúçÂä°', doc: 'http://10.8.109.232:10270' },
              preplanAnalysisBiz: { noSwagger:false, desc: 'È¢ÑÊ°àÂàÜÊûêÊúçÂä°', doc: 'http://10.8.109.235:3089' },
              preplanBiz: { noSwagger:true, desc: '‰∫ã‰ª∂ÊúçÂä°-È¢ÑÊ°à', doc: 'http://10.8.109.235:3088' },
              quartzBiz: { noSwagger:false, desc: 'ÂÆöÊó∂‰ªªÂä°ÊúçÂä°', doc: 'http://10.8.109.235:5198' },
              resourceBiz: { noSwagger:false, desc: 'ÈùôÊÄÅËµÑÊ∫êÊúçÂä°', doc: '' },
              rrsBiz: { noSwagger:false, desc: 'ËµÑÊ∫êÂÖ≥ËÅîÊúçÂä°', doc: 'http://10.8.109.235:54229' },
              scheduleBiz: { noSwagger:false, desc: 'Êó•Á®ãÊúçÂä°', doc: 'http://10.8.109.235:38839' },
              taskBiz: { noSwagger:true, desc: '‰∫ã‰ª∂ÊúçÂä°-‰ªªÂä°', doc: 'http://10.8.109.235:3088' },
              vcsBiz: { noSwagger:false, desc: 'ËßÜÈ¢ë‰ºöËÆÆÊúçÂä°', doc: 'http://10.8.109.235:41303' },
              videoFusionServiceBiz: { noSwagger:false, desc: 'ËßÜÈ¢ëËûçÂêàÊúçÂä°', doc: 'http://10.8.109.235:3078' },
              viscsBiz: { noSwagger:false, desc: 'ÂèØËßÜÂåñÈÖçÁΩÆÊúçÂä°', doc: 'http://10.8.109.231:12360' },
              wxBiz: { noSwagger:false, desc: 'Ê∞îË±°ÊúçÂä°', doc: 'http://10.8.109.235:52551' },
            };
          },
          // ÊêúÁ¥¢ÂÖ≥Á≥ªÊò†Â∞Ñ
          searchKeyMap() {
            return { 1: 'methodName', 2: 'url', 3: 'summary' }[this.searchType];
          },
          // ËØ∑Ê±ÇÁ±ªÂûãÊºîÁ§∫Êò†Â∞Ñ
          methodColorType: () => ({ get: 'info', post: 'success', put: 'warning', delete: 'danger' }),
        },

        methods: {
          // ÊêúÁ¥¢
          search() {
            this.expands = [];
            const specialBiz = ['preplanBiz', 'taskBiz', 'associatedBiz', 'eventBiz'];
            let list = Object.entries(this.bizData).reduce((pre, [bizName, fnList]) => pre.concat(fnList.map((i) => ({ ...i, bizName }))), []);
            if (this.activeBizName) {
              list = specialBiz.includes(this.activeBizName) ? list.filter((i) => i.subBiz === this.activeBizName) : this.bizData[this.activeBizName].map((i) => ({ ...i, bizName: this.activeBizName }));
            }
            if (this.searchValue) {
              list = list
                .reduce((pre, item) => {
                  const { flag, compatTotal } = this.fuzzyMatch(item[this.searchKeyMap], this.searchValue);
                  return flag ? [...pre, { ...item, compatTotal }] : pre;
                }, [])
                .sort((a, b) => b.compatTotal - a.compatTotal);
            }
            this.tableData = list;
          },
          // ÈáçÁΩÆ
          reset() {
            this.searchValue = '';
            this.search();
          },
          // ÂèÇÊï∞Ê†ºÂºèÂåñ
          getParams(data) {
            const formatParamsData = data.methods === 'get' ? data.parameters || [] : [].concat(data.parameters || [], data.requestBody || []) || [];
            return formatParamsData.reduce((obj, i) => {
              let str = `ÂèÇÊï∞Á±ªÂûãÔºö${i?.in === 'header' ? 'headers' : i.type} ÂèÇÊï∞ËØ¥ÊòéÔºö${i?.description || 'Á©∫'} ${i?.default ? ' ÈªòËÆ§ÂÄºÔºö' + i?.default : ''} ${i?.required ? 'ÔºàÂøÖÂ°´Ôºâ' : ''}`;
              return { ...obj, [i.key]: str };
            }, {});
          },
          // ÂìçÂ∫îÊ†ºÂºèÂåñ
          getResponse(data) {
            if (!data.responses) return {};
            return data.responses.reduce((pre, i) => ({ ...pre, [i.key]: i.description }), {});
          },
          // ËØ∑Ê±ÇÁ§∫‰æãÁîüÊàê
          getExample(data) {
            const formatParamsData = data.methods === 'get' ? data.parameters || [] : [].concat(data.parameters || [], data.requestBody || []) || [];
            const requiredParams = formatParamsData.filter((i) => i.required);
            return `this.${data.subBiz || data.bizName}.${data.methodName}(${!formatParamsData.length ? '' : requiredParams.length === 1 ? requiredParams?.[0]?.key : 'params'})`;
          },
          // Ë∑≥ËΩ¨ÊñáÊ°£Âú∞ÂùÄ
          skipSwagger(data) {
           console.log("skipSwagger ~ data", data)
            if(this.descMap[data.bizName]?.noSwagger){
              let url = data.operationId ? 
              `${this.descMap[data.bizName]?.doc}/index.html#/${data.version}/${data.tag}/${data.operationId}?x=1&methodName=${data.bizName}.${data.methodName}` : 
              `${this.descMap[data.bizName]?.doc}/index.html#/?x=1&version=${data.version}&tag=${data.tag}&url=${data.url}&requestType=${data.methods.toUpperCase()}&methodName=${data.bizName}.${data.methodName}`
              window.open(url);
            } else {
              try {
                let hash = `#operations-${data.tag}-${data?.operationId || data.methods + data.url.replace(/\/|\{|\}/g, '_')}`;
                window.open(`${this.descMap[data.bizName]?.doc}/swagger/index.html${data.version !== 'v1' ? '?urls.primaryName=' + data.version : ''}${hash}&methodName=${data.bizName}.${data.methodName}`);
              } catch (error) {
                window.open(`${this.descMap[data.bizName]?.doc}/swagger/index.html${data.version !== 'v1' ? '?urls.primaryName=' + data.version : ''}&methodName=${data.bizName}.${data.methodName}`);
              }
            }
          },
          // Ê®°Á≥äÂåπÈÖç
          fuzzyMatch(str, key) {
            let index = -1,
              flag = false,
              compatTotal = str.split(key)?.length ?? 0;

            for (let i = 0, arr = key.split(''); i < arr.length; i++) {
              if (str.indexOf(arr[i]) < 0) {
                break;
              } else {
                let match = str.matchAll(RegExp(arr[i], 'gi'));
                let next = match.next();
                while (!next.done) {
                  if (next.value.index > index) {
                    index = next.value.index;
                    if (i === arr.length - 1) {
                      flag = true;
                    }
                    break;
                  }
                  next = match.next();
                }
              }
            }
            return { flag, compatTotal };
          },
          // Â∑¶‰æßËèúÂçïÁÇπÂáª
          menuClick(val) {
            this.activeBizName = val;
            this.search();
          },
          // Ë°®Ê†ºË°åÁÇπÂáª
          clickRowHandle(row, column, event) {
            if (column.label === 'ÊñáÊ°£Âú∞ÂùÄ') return;
            if (this.expands.includes(row.methodName)) {
              this.expands = this.expands.filter((val) => val !== row.methodName);
            } else {
              this.expands.push(row.methodName);
            }
          },
          // Â§çÂà∂ÂáΩÊï∞Âêç
          async copyName({bizName,methodName}){
            try {
              await navigator.clipboard.writeText(bizName+'.'+methodName+'()');
              this.$message({
                type:'success',
                message: 'Â§çÂà∂ÊàêÂäü',
                duration: 1800
              });
            } catch (err) {
              console.error('Failed to copy: ', err);
            }
          },
          // ‰øÆÊîπÊòæÁ§∫Ê®°Âºè
          setDefaultShowType(val) {
            this.dark = val;
            localStorage.setItem('dark', val);
            document.querySelector('html').setAttribute('data-theme', val ? 'dark' : 'light');
          }
        },
      };
      Vue.createApp(App).use(ElementPlus).mount('#app');
    </script>
  </body>
</html>
